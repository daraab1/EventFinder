<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ ev.name or 'Event' }}</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 16px; line-height: 1.4; background: #7f9bee; }
      #map { height: 380px; width: 100%; border-radius: 12px; margin-top: 8px; }
      .meta { color: #000000; }
    </style>
  </head>
  <body>
    <p><a href="{{ url_for('main.show_events') }}">&larr; Back to results</a></p>

    <h1>{{ ev.name }}</h1>
    <p class="meta">
      {% if ev.start %}<strong>Starts:</strong> {{ ev.start }} &nbsp;{% endif %}
      {% if ev.venue %}<strong>Venue:</strong> {{ ev.venue }} &nbsp;{% endif %}
      {% if ev.address %}<strong>Address:</strong> {{ ev.address }}{% endif %}
    </p>
    {% if ev.url %}
      <p><a href="{{ ev.url }}" target="_blank" rel="noopener">View on Ticketmaster</a></p>
    {% endif %}

    {% if ev.lat and ev.lon %}
      <div id="map"
           data-lat="{{ ev.lat }}"
           data-lon="{{ ev.lon }}"
           data-name='{{ ev.name|tojson }}'
           data-venue='{{ ev.venue|default("", true)|tojson }}'
           data-addr='{{ ev.address|default("", true)|tojson }}'></div>
    {% else %}
      <p>Map unavailable for this event (no coordinates found).</p>
    {% endif %}

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    {% if ev.lat and ev.lon %}
    <script>
      const el   = document.getElementById('map');
      const lat  = parseFloat(el.dataset.lat);
      const lon  = parseFloat(el.dataset.lon);
      const name = JSON.parse(el.dataset.name || '""');
      const venue = JSON.parse(el.dataset.venue || '""');
      const addr  = JSON.parse(el.dataset.addr  || '""');

      const map = L.map('map').setView([lat, lon], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const popupHtml = `<strong>${name}</strong><br>${venue ? venue + '<br>' : ''}${addr}`;
      L.marker([lat, lon]).addTo(map).bindPopup(popupHtml).openPopup();
    </script>
    {% endif %}
  </body>
</html>